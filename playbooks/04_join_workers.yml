- name: Join worker nodes to the Kubernetes cluster
  hosts: k8s_workers
  become: true
  tasks:
    - name: Read join command from master node
      ansible.builtin.slurp:
        src: /tmp/k8s_join_command.txt
      register: join_command_file
      delegate_to: k8s-master-01

    - name: Run kubeadm join on worker
      ansible.builtin.shell: "{{ join_command_file.content | b64decode }}"
      args:
        creates: /etc/kubernetes/kubelet.conf

    - name: Wait for kubelet.conf to appear
      ansible.builtin.wait_for:
        path: /etc/kubernetes/kubelet.conf
        timeout: 180

    - name: Check node status from master
      ansible.builtin.command: kubectl get nodes {{ inventory_hostname }}
      register: node_status
      delegate_to: k8s-master-01
      retries: 10
      delay: 10
      until: "'NotReady' in node_check.stdout or 'Ready' in node_check.stdout"

    - name: Show join status
      ansible.builtin.debug:
        msg: "Node {{ inventory_hostname }} joined successfully"
