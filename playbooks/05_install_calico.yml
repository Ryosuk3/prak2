- name: Install Calico network plugin
  hosts: k8s_master
  become: true
  tasks:
    - name: Apply Calico manifest
      ansible.builtin.command: >
        kubectl apply -f
        https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
      register: calico_apply
      changed_when: "'created' in calico_apply.stdout or 'configured' in calico_apply.stdout"

    - name: Wait for calico-node pods to be Ready
      ansible.builtin.command: >
        kubectl -n kube-system wait --for=condition=ready pod -l k8s-app=calico-node --timeout=300s
      register: calico_wait
      retries: 3
      delay: 10
      until: calico_wait.rc == 0

    - name: Wait for all kube-system pods to be Ready
      ansible.builtin.command: >
        kubectl -n kube-system wait --for=condition=ready pod --all --timeout=300s
      register: system_wait
      retries: 3
      delay: 10
      until: system_wait.rc == 0

    - name: Show cluster nodes
      ansible.builtin.command: kubectl get nodes -o wide
      register: cluster_status

    - name: Display cluster status
      ansible.builtin.debug:
        msg: "{{ cluster_status.stdout }}"

    - name: Show kube-system pods
      ansible.builtin.command: kubectl get pods -n kube-system
      register: system_pods

    - name: Display kube-system pods
      ansible.builtin.debug:
        msg: "{{ system_pods.stdout }}"
